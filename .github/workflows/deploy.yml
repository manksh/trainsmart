name: Deploy to GCP

on:
  push:
    branches: [main]

env:
  PROJECT_ID: trainsmart-481620
  REGION: us-central1
  BACKEND_IMAGE: us-central1-docker.pkg.dev/trainsmart-481620/trainsmart/backend
  FRONTEND_IMAGE: us-central1-docker.pkg.dev/trainsmart-481620/trainsmart/frontend
  BACKEND_SERVICE: trainsmart-backend
  FRONTEND_SERVICE: trainsmart-frontend
  WORKLOAD_IDENTITY_PROVIDER: projects/922138784988/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-actions@trainsmart-481620.iam.gserviceaccount.com

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          # Submit build asynchronously to avoid log streaming permission issues
          BUILD_ID=$(gcloud builds submit ./backend \
            --tag ${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
            --tag ${{ env.BACKEND_IMAGE }}:latest \
            --async \
            --format='value(id)')

          echo "Build ID: $BUILD_ID"

          # Wait for build to complete
          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --format='value(status)')
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Build completed successfully"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "Build failed with status: $STATUS"
              # Try to get build logs
              gcloud builds log $BUILD_ID --limit=100 || true
              exit 1
            fi

            sleep 10
          done

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image ${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }}

      - name: Run Migrations
        run: |
          gcloud run jobs execute trainsmart-migrations \
            --region ${{ env.REGION }} \
            --wait

  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        working-directory: frontend
        run: |
          # Submit build asynchronously to avoid log streaming permission issues
          BUILD_ID=$(gcloud builds submit --config=cloudbuild.yaml . \
            --async \
            --format='value(id)')

          echo "Build ID: $BUILD_ID"

          # Wait for build to complete
          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --format='value(status)')
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Build completed successfully"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "Build failed with status: $STATUS"
              # Try to get build logs
              gcloud builds log $BUILD_ID --limit=100 || true
              exit 1
            fi

            sleep 10
          done

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image ${{ env.FRONTEND_IMAGE }}:latest \
            --region ${{ env.REGION }}
