name: Deploy to PROD

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type DEPLOY-PROD to confirm production deployment'
        required: true
        type: string
      run_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy backend'
        required: false
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy frontend'
        required: false
        type: boolean
        default: true

env:
  PROJECT_ID: trainsmart-481620
  REGION: us-central1
  BACKEND_IMAGE: us-central1-docker.pkg.dev/trainsmart-481620/trainsmart/backend
  FRONTEND_IMAGE: us-central1-docker.pkg.dev/trainsmart-481620/trainsmart/frontend
  BACKEND_SERVICE: trainsmart-backend-prod
  FRONTEND_SERVICE: trainsmart-frontend-prod
  MIGRATIONS_JOB: trainsmart-migrations-prod
  WORKLOAD_IDENTITY_PROVIDER: projects/922138784988/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-actions@trainsmart-481620.iam.gserviceaccount.com

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'DEPLOY-PROD' }}
        run: |
          echo "âŒ Deployment cancelled. You must type 'DEPLOY-PROD' to confirm."
          exit 1
      - name: Confirmation accepted
        run: echo "âœ… Production deployment confirmed"

  deploy-backend:
    needs: validate
    if: ${{ github.event.inputs.deploy_backend == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          # Tag with commit SHA for traceability
          COMMIT_SHA=${{ github.sha }}

          BUILD_ID=$(gcloud builds submit ./backend \
            --tag ${{ env.BACKEND_IMAGE }}:${COMMIT_SHA} \
            --async \
            --format='value(id)')

          echo "Build ID: $BUILD_ID"

          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --format='value(status)')
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Build completed successfully"
              # Also tag as latest
              gcloud artifacts docker tags add \
                ${{ env.BACKEND_IMAGE }}:${COMMIT_SHA} \
                ${{ env.BACKEND_IMAGE }}:latest
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "Build failed with status: $STATUS"
              gcloud builds log $BUILD_ID --limit=100 || true
              exit 1
            fi

            sleep 10
          done

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image ${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }}

      - name: Run Migrations
        if: ${{ github.event.inputs.run_migrations == 'true' }}
        run: |
          gcloud run jobs execute ${{ env.MIGRATIONS_JOB }} \
            --region ${{ env.REGION }} \
            --wait

  deploy-frontend:
    needs: validate
    if: ${{ github.event.inputs.deploy_frontend == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        working-directory: frontend
        run: |
          COMMIT_SHA=${{ github.sha }}

          # Create a prod-specific cloudbuild that sets the PROD API URL
          cat > cloudbuild-prod.yaml << 'EOF'
          steps:
            - name: 'gcr.io/cloud-builders/docker'
              args:
                - 'build'
                - '-t'
                - 'us-central1-docker.pkg.dev/trainsmart-481620/trainsmart/frontend:$COMMIT_SHA'
                - '--build-arg'
                - 'NEXT_PUBLIC_API_URL=https://api.ctlstlabs.com'
                - '.'
          images:
            - 'us-central1-docker.pkg.dev/trainsmart-481620/trainsmart/frontend:$COMMIT_SHA'
          EOF

          BUILD_ID=$(gcloud builds submit --config=cloudbuild-prod.yaml . \
            --substitutions=COMMIT_SHA=${COMMIT_SHA} \
            --async \
            --format='value(id)')

          echo "Build ID: $BUILD_ID"

          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --format='value(status)')
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Build completed successfully"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "Build failed with status: $STATUS"
              gcloud builds log $BUILD_ID --limit=100 || true
              exit 1
            fi

            sleep 10
          done

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image ${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }}

  notify:
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ PROD Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** ${{ needs.deploy-backend.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** ${{ needs.deploy-frontend.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PROD URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://ctlstlabs.com" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://api.ctlstlabs.com" >> $GITHUB_STEP_SUMMARY
